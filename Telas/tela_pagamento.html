<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-TRF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escolha como pagar</title>
  
  <link rel="stylesheet" href="estilo_entrega.css">
  
  <link rel="stylesheet" href="estilo_pagamento.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  </head>
<body>

     <header class="topbar-entrega">
      <nav class="actions-entrega">
        <div class="logo-container">
          <a href="index.html">
            <img src="imagens/exemplo-logo.png"" alt="Logo" style="width: 40px; height: 40px;">
          </a>
        </div>
        <div class="user-menu">
          <a href="#">Contato</a>
        </div>
      </nav>
    </header>

<main class="entrega-layout-container">
        
        <div class="opcoes-entrega">
            <h2>Escolha como pagar</h2>
            
            <form id="form-pagamento">
                
                <h4 class="subtitulo-pagamento">Recomendados</h4>

                <div class="opcao-bloco selecionado">
                    <input type="radio" id="linha-credito" name="forma-pagamento" value="linha-credito" checked>
                    <span class="icone-linha-credito">$</span> 
                    <label for="linha-credito" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Linha de Crédito</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Disponível: R$ 100,00</p>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="nubank" name="forma-pagamento" value="nubank">
                    <i class="fa-regular fa-credit-card icone-pagamento"></i>
                    <label for="nubank" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Cartão **** 1234</span>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="pix" name="forma-pagamento" value="pix">
                    <i class="fa-brands fa-pix icone-pagamento"></i>
                    <label for="pix" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Pix</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Aprovação imediata</p>
                        </div>
                    </label>
                </div>
                <h4 class="subtitulo-pagamento">Cartões</h4>

                <div class="opcao-bloco">
                    <input type="radio" id="novo-cartao" name="forma-pagamento" value="novo-cartao">
                    <i class="fa-regular fa-credit-card icone-pagamento"></i>
                    
                    <label for="novo-cartao" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Novo cartão de crédito</span>
                        </div>
                    
                        <div class="formulario-novo-cartao" id="formulario-novo-cartao">
                            
                            <div class="form-coluna-esquerda">
                                <div class="form-grupo" id="grupo-numero-cartao">
                                    <label for="numero-cartao">Número do cartão</label>
                                    <input type="text" id="numero-cartao" placeholder="1234 1234 1234 1234">
                                    <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>
                                
                                <div class="form-grupo" id="grupo-nome-titular">
                                    <label for="nome-titular">Nome do titular</label>
                                    <input type="text" id="nome-titular" placeholder="Ex.: Fulano Silva">
                                    <span class="helper-text">Conforme aparece no cartão.</span>
                                    <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>

                                <div class="form-linha">
                                    <div class="form-grupo" style="flex: 1;" id="grupo-vencimento">
                                        <label for="vencimento">Vencimento</label>
                                        <input type="text" id="vencimento" placeholder="MM/AA">
                                        <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                    </div>
                                    <div class="form-grupo" style="flex: 1;" id="grupo-cvv">
                                        <label for="cvv">Código de segurança <i class="fa-regular fa-circle-question" title="Os 3 dígitos atrás do cartão"></i></label>
                                        <input type="text" id="cvv" placeholder="Ex.: 123">
                                        <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                    </div>
                                </div>

                                <div class="form-grupo" id="grupo-documento">
                                    <label for="documento">Documento do titular</label>
                                    <div class="form-linha-documento">
                                        <select id="tipo-documento">
                                            <option value="CPF">CPF</option>
                                            <option value="CNPJ">CNPJ</option>
                                        </select>
                                        <input type="text" id="documento" placeholder="999.999.999-99" style="flex: 1;">
                                    </div>
                                     <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>
                            </div> 
                            <!-- Retirado -->
                            <!-- <div class="form-coluna-direita">
                                <img src="imagens/cartao-generico.png" alt="Cartão de crédito">
                            </div> -->

                        </div>
                    </label> </div>


                <h4 class="subtitulo-pagamento">Outros meios de pagamento</h4>
                
                <div class="opcao-bloco">
                    <input type="radio" id="boleto" name="forma-pagamento" value="boleto">
                    <i class="fa-solid fa-barcode icone-pagamento"></i>
                    <label for="boleto" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Boleto</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Aprovação em 1 a 2 dias úteis</p>
                        </div>
                    </label>
                </div>
                
                <button type="button" class="btn-continuar-entrega">Continuar</button>
            </form>
        </div>

        
        <aside class="resumo-compra">
            <h3>Resumo da compra</h3>
            
            <div class="resumo-linha">
                <span>Produto</span>
                <span id="resumo-produto-valor">R$ 0,00</span>
            </div>
            
            <div class="resumo-linha">
                <span>Frete</span>
                <span id="resumo-frete-valor">R$ 0,00</span>
            </div>
            
            <a href="#" class="link-cupom">Inserir código do cupom</a>
            
            <div class="resumo-linha total">
                <span>Você pagará</span>
                <span id="resumo-total-valor">R$ 0,00</span>
            </div>
        </aside>

    </main>

    <script>
        // ... (Função gerarNotaFiscalPDF() - sem alteração) ...
        function gerarNotaFiscalPDF() {
            // Pega a biblioteca jsPDF que importamos no <head>
            const { jsPDF } = window.jspdf;
            // Cria um novo documento PDF em orientação "retrato" (p), unidades "mm", formato "a4"
            const doc = new jsPDF('p', 'mm', 'a4'); 

            // --- Pega os dados do localStorage (Compra) ---
            const subtotal = localStorage.getItem("totalCompra") || "0.00";
            const frete = localStorage.getItem("valorFrete") || "0.00";
            const total = localStorage.getItem("valorFinal") || "0.00";
            const dataEmissao = new Date().toLocaleDateString('pt-BR');
            const fSubtotal = parseFloat(subtotal).toFixed(2).replace(".", ",");
            const fFrete = parseFloat(frete).toFixed(2).replace(".", ",");
            const fTotal = parseFloat(total).toFixed(2).replace(".", ",");
            
            
            // --- Pega os Dados de Entrega do localStorage ---
            const dadosEntregaJSON = localStorage.getItem('dadosEntrega');
            const fallbackEntrega = {
                tipo: 'endereco',
                nome: 'Fulano Silva',
                documento: '123.456.789-00',
                endereco: 'Exemplo Fictício, 123',
                bairro: 'Centro',
                cep: '13180-000',
                municipio: 'Hortolândia',
                uf: 'SP',
                fone: '(19) 99999-9999'
            };
            let entrega;
            try {
                entrega = dadosEntregaJSON ? JSON.parse(dadosEntregaJSON) : fallbackEntrega;
                if (!entrega.nome || !entrega.endereco) {
                     entrega = fallbackEntrega;
                }
            } catch (e) {
                console.error("Erro ao ler dadosEntrega do localStorage:", e);
                entrega = fallbackEntrega;
            }

            // --- Define margens e colunas ---
            const margemEsq = 10;
            const margemDir = 200; 
            const colCentro = 105;

            // --- Cabeçalho e Dados (Emitente/Destinatário) ---
            doc.setFontSize(18);
            doc.text("NOTA FISCAL", colCentro, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("DADOS DO EMITENTE", margemEsq, 35);
            doc.setFont("helvetica", "normal");
            doc.text("LOJA LTDA", margemEsq, 42);
            doc.text("CNPJ: 00.123.456/0001-78", margemEsq, 49);
            doc.text("Inscrição Estadual: 123.456.789.110", margemEsq, 56);
            doc.setFont("helvetica", "bold");
            doc.text("DADOS DO DESTINATÁRIO", colCentro, 35);
            doc.setFont("helvetica", "normal");
            doc.text("Nome: Fulano Silva", colCentro, 42); 
            doc.text("CPF: 123.456.789-00", colCentro, 49);
            doc.text("Inscrição Estadual: ISENTO", colCentro, 56);

            
            // --- INFORMAÇÕES DO LOCAL DE ENTREGA (DINÂMICO) ---
            let y = 70; 
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            
            const tituloEntrega = entrega.tipo === 'agencia' ?
                "INFORMAÇÕES DO LOCAL DE RETIRADA (AGÊNCIA)" :
                "INFORMAÇÕES DO LOCAL DE ENTREGA / RETIRADA";
            doc.text(tituloEntrega, margemEsq, y);
            y += 3; 

            // Caixas
            doc.rect(margemEsq, y, 190, 30); 
            doc.line(margemEsq, y + 10, margemDir, y + 10); 
            doc.line(margemEsq, y + 20, margemDir, y + 20); 
            doc.line(120, y, 120, y + 20);
            doc.line(160, y, 160, y + 20);
            doc.line(120, y + 20, 120, y + 30);
            doc.line(160, y + 20, 160, y + 30); 

            // Títulos
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text("NOME/RAZÃO SOCIAL", margemEsq + 1, y + 3);
            doc.text("C.N.P.J / C.P.F.", 121, y + 3);
            doc.text("INSCRIÇÃO ESTADUAL", 161, y + 3);
            doc.text("ENDEREÇO", margemEsq + 1, y + 13);
            doc.text("BAIRRO/DISTRITO", 121, y + 13);
            doc.text("CEP", 161, y + 13);
            doc.text("MUNICÍPIO", margemEsq + 1, y + 23);
            doc.text("UF", 121, y + 23); 
            doc.text("FONE/FAX", 161, y + 23); 
            
            // Dados Dinâmicos
            doc.setFontSize(10);
            doc.text(entrega.nome, margemEsq + 1, y + 7); 
            doc.text(entrega.documento, 121, y + 7);      
            doc.text("ISENTO", 161, y + 7);
            doc.text(entrega.endereco, margemEsq + 1, y + 17); 
            doc.text(entrega.bairro, 121, y + 17);
            doc.text(entrega.cep, 161, y + 17);
            doc.text(entrega.municipio, margemEsq + 1, y + 27);
            doc.text(entrega.uf, 121, y + 27); 
            doc.text(entrega.fone, 161, y + 27); 

            y += 35; 
            
            // --- Descrição dos Produtos ---
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("DESCRIÇÃO DOS PRODUTOS", margemEsq, y);
            y += 5;
            doc.setFont("helvetica", "normal");
            doc.text("Qtd.", margemEsq, y);
            doc.text("Un.", margemEsq + 15, y);
            doc.text("Descrição", margemEsq + 30, y);
            doc.text("Valor Unit.", margemEsq + 140, y);
            doc.text("Valor Total", margemEsq + 170, y);
            doc.line(margemEsq, y + 2, margemDir, y + 2);
            y += 7;
            doc.text("1", margemEsq, y);
            doc.text("UN", margemEsq + 15, y);
            doc.text("Produto Exemplo Comprado no Site", margemEsq + 30, y);
            doc.text(fSubtotal, margemEsq + 140, y);
            doc.text(fSubtotal, margemEsq + 170, y);
            y += 7;
            doc.text("1", margemEsq, y);
            doc.text("UN", margemEsq + 15, y);
            doc.text("Serviço de Entrega (Frete)", margemEsq + 30, y);
            doc.text(fFrete, margemEsq + 140, y);
            doc.text(fFrete, margemEsq + 170, y);
            y += 10;
            
            // --- CÁLCULO DO IMPOSTO ---
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("CÁLCULO DO IMPOSTO", margemEsq, y);
            y += 3;
            doc.rect(margemEsq, y, 190, 20); 
            doc.line(margemEsq, y + 10, margemDir, y + 10); 
            doc.line(48, y, 48, y + 10);
            doc.line(73, y, 73, y + 10);
            doc.line(145, y, 145, y + 10); 
            doc.line(48, y + 10, 48, y + 20);
            doc.line(74, y + 10, 74, y + 20);
            doc.line(105, y + 10, 105, y + 20);
            doc.line(159, y + 10, 159, y + 20); 
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text("BASE DE CÁLCULO DO ICMS", margemEsq + 1, y + 3);
            doc.text("VALOR DO ICMS", 49, y + 3);
            doc.text("BASE DE CÁLCULO DO ICMS SUBSTITUIÇÃO", 74, y + 3);
            doc.text("VALOR TOTAL DOS PRODUTOS", 146, y + 3); 
            doc.text("VALOR DO FRETE", margemEsq + 1, y + 13);
            doc.text("VALOR DO SEGURO", 49, y + 13);
            doc.text("DESCONTO", 75, y + 13);
            doc.text("OUTRAS DESPESAS ACESSÓRIAS", 106, y + 13);
            doc.text("VALOR TOTAL DA NOTA", 160, y + 13); 
            doc.setFontSize(10);
            doc.text("0,00", 47, y + 7, { align: 'right' });
            doc.text("0,00", 72, y + 7, { align: 'right' });
            doc.text("0,00", 144, y + 7, { align: 'right' });
            doc.text(fSubtotal, 199, y + 7, { align: 'right' }); 
            doc.text(fFrete, 47, y + 17, { align: 'right' }); 
            doc.text("0,00", 72, y + 17, { align: 'right' });
            doc.text("0,00", 104, y + 17, { align: 'right' });
            doc.text("0,00", 158, y + 17, { align: 'right' });
            doc.text(fTotal, 199, y + 17, { align: 'right' }); 
            y += 25; 
            
            // --- Datas ---
            doc.setFont("helvetica", "bold");
            doc.text("Data de Emissão:", margemEsq, y);
            doc.setFont("helvetica", "normal");
            doc.text(dataEmissao, margemEsq + 35, y);
            doc.setFont("helvetica", "bold");
            doc.text("Data de Saída:", colCentro, y);
            doc.setFont("helvetica", "normal");
            doc.text(dataEmissao, colCentro + 30, y);

            // --- Salva o arquivo ---
            doc.save("nota_fiscal_simulada.pdf");
        }
        
        // --- Carregar dados do localStorage ---
        document.addEventListener("DOMContentLoaded", function() {

            // ... (Funções formatarMoeda e formatarFrete - sem alteração) ...
            function formatarMoeda(valorStr) {
                const numero = parseFloat(valorStr);
                if (isNaN(numero)) return "R$ 0,00";
                return "R$ " + numero.toFixed(2).replace(".", ",");
            }
            function formatarFrete(valorStr) {
                const numero = parseFloat(valorStr);
                if (isNaN(numero) || numero === 0) {
                    return "GRÁTIS";
                }
                return formatarMoeda(valorStr); 
            }

            // ... (Carregamento dos valores do Resumo - sem alteração) ...
            const subtotal = localStorage.getItem("totalCompra"); 
            const frete = localStorage.getItem("valorFrete");
            const totalFinal = localStorage.getItem("valorFinal");
            const elProduto = document.getElementById("resumo-produto-valor");
            const elFrete = document.getElementById("resumo-frete-valor");
            const elTotal = document.getElementById("resumo-total-valor");
            if (elProduto && subtotal !== null) { elProduto.innerText = formatarMoeda(subtotal); }
            if (elFrete && frete !== null) {
                elFrete.innerText = formatarFrete(frete);
                if (parseFloat(frete) === 0) { elFrete.classList.add("preco-gratis"); } 
                else { elFrete.classList.remove("preco-gratis"); }
            }
            if (elTotal && totalFinal !== null) { elTotal.innerText = formatarMoeda(totalFinal); }
            
            // ... (Referências aos elementos do formulário - sem alteração) ...
            const formNovoCartao = document.getElementById('formulario-novo-cartao');
            const radioNovoCartao = document.getElementById('novo-cartao');
            const radioLinhaCredito = document.getElementById('linha-credito');
            const radioPix = document.getElementById('pix');
            const radioBoleto = document.getElementById('boleto');
            const radioNubank = document.getElementById('nubank'); 
            const grupoNumero = document.getElementById('grupo-numero-cartao');
            const grupoNome = document.getElementById('grupo-nome-titular');
            const grupoVencimento = document.getElementById('grupo-vencimento');
            const grupoCvv = document.getElementById('grupo-cvv');
            const grupoDocumento = document.getElementById('grupo-documento');
            const inputNumero = document.getElementById('numero-cartao');
            const inputNome = document.getElementById('nome-titular');
            const inputVencimento = document.getElementById('vencimento');
            const inputCvv = document.getElementById('cvv');
            const inputDocumento = document.getElementById('documento');
            const selectTipoDocumento = document.getElementById('tipo-documento'); 


            // ... (LÓGICA DAS MÁSCARAS DE INPUT - sem alteração) ...
            inputNumero.setAttribute('maxlength', '19'); 
            inputVencimento.setAttribute('maxlength', '5'); 
            inputCvv.setAttribute('maxlength', '3'); 
            inputDocumento.setAttribute('maxlength', '14'); 
            inputNumero.addEventListener('input', (e) => {
                let valor = e.target.value.replace(/\D/g, ''); 
                valor = valor.substring(0, 16); 
                const grupos = valor.match(/.{1,4}/g); 
                e.target.value = grupos ? grupos.join(' ') : '';
            });
            inputVencimento.addEventListener('input', (e) => {
                let valor = e.target.value.replace(/\D/g, ''); 
                valor = valor.substring(0, 4); 
                if (valor.length > 2) {
                    valor = valor.substring(0, 2) + '/' + valor.substring(2);
                }
                e.target.value = valor;
            });
            inputCvv.addEventListener('input', (e) => {
                let valor = e.target.value.replace(/\D/g, ''); 
                valor = valor.substring(0, 3); 
                e.target.value = valor;
            });
            inputDocumento.addEventListener('input', (e) => {
                let valor = e.target.value.replace(/\D/g, ''); 
                const tipo = selectTipoDocumento.value;
                if (tipo === 'CPF') {
                    valor = valor.substring(0, 11); 
                    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                    valor = valor.replace(/(\d{3})\.(\d{3})(\d)/, '$1.$2.$3');
                    valor = valor.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
                } else { 
                    valor = valor.substring(0, 14); 
                    valor = valor.replace(/(\d{2})(\d)/, '$1.$2');
                    valor = valor.replace(/(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    valor = valor.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4');
                    valor = valor.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
                }
                e.target.value = valor;
            });
            selectTipoDocumento.addEventListener('change', (e) => {
                inputDocumento.value = ''; 
                if (e.target.value === 'CPF') {
                    inputDocumento.placeholder = '999.999.999-99';
                    inputDocumento.setAttribute('maxlength', '14');
                } else {
                    inputDocumento.placeholder = '99.999.999/0001-99';
                    inputDocumento.setAttribute('maxlength', '18');
                }
            });
            
            // ... (Lógica de seleção dos blocos e exibição do formulário - sem alteração) ...
            document.querySelectorAll('input[name="forma-pagamento"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.querySelectorAll('.opcao-bloco').forEach(bloco => {
                        if (!bloco.classList.contains('combinar-pagamento')) {
                             bloco.classList.remove('selecionado');
                        }
                    });
                    if (this.checked) {
                        this.closest('.opcao-bloco').classList.add('selecionado');
                    }
                    if (radioNovoCartao.checked) {
                        formNovoCartao.style.display = 'flex'; 
                    } else {
                        formNovoCartao.style.display = 'none'; 
                        resetarErrosCartao(); 
                    }
                });
            });

            // ... (Função validarFormularioCartao - sem alteração) ...
            function validarFormularioCartao() {
                let isValid = true;
                resetarErrosCartao(); 
                if (inputNumero.value.trim() === '') { grupoNumero.classList.add('campo-com-erro'); isValid = false; }
                if (inputNome.value.trim() === '') { grupoNome.classList.add('campo-com-erro'); isValid = false; }
                if (inputVencimento.value.trim() === '') { grupoVencimento.classList.add('campo-com-erro'); isValid = false; }
                if (inputCvv.value.trim() === '') { grupoCvv.classList.add('campo-com-erro'); isValid = false; }
                 if (inputDocumento.value.trim() === '') { grupoDocumento.classList.add('campo-com-erro'); isValid = false; }
                return isValid; 
            }
            
            // ... (Função resetarErrosCartao - sem alteração) ...
            function resetarErrosCartao() {
                [grupoNumero, grupoNome, grupoVencimento, grupoCvv, grupoDocumento].forEach(grupo => {
                    if(grupo) grupo.classList.remove('campo-com-erro');
                });
            }


            // =============================================
            // === LÓGICA DO BOTÃO "CONTINUAR" (MODIFICADA)
            // =============================================
            const btnContinuarPagina = document.querySelector('.btn-continuar-entrega');
            
            btnContinuarPagina.addEventListener('click', function() {
                
                // --- Caso 1: Pagamento com "Novo Cartão" ---
                if (radioNovoCartao.checked) {
                    const isCartaoValido = validarFormularioCartao();
                    if (isCartaoValido) {
                        alert("Pagamento (com novo cartão) processado! Gerando nota fiscal...");
                        // Chama a função que cria o PDF
                        gerarNotaFiscalPDF(); 
                    } else {
                        // Se o formulário for inválido, apenas loga no console e não faz nada.
                        console.log("Formulário de cartão inválido. Por favor, corrija os campos.");
                    }
                
                // --- Caso 2: Pagamento com "Cartão Salvo" (Nubank) ---
                } else if (radioNubank.checked) {
                     alert("Pagamento (com cartão salvo) processado! Gerando nota fiscal...");
                     // Chama a função que cria o PDF
                     gerarNotaFiscalPDF(); 

                // --- Caso 3: Outros pagamentos (Linha de Crédito, Pix ou Boleto) ---
                } else if (radioLinhaCredito.checked || radioPix.checked || radioBoleto.checked) {
                    
                    alert("Pagamento processado! Gerando sua nota fiscal...");
                    // Chama a função que cria o PDF
                    gerarNotaFiscalPDF();

                } else {
                    // Nenhuma opção válida selecionada
                    alert("Por favor, selecione um método de pagamento.");
                }
            });

        }); // <-- Fim do DOMContentLoaded
    </script>
    </body>
</html>