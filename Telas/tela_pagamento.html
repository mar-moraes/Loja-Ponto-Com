<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escolha como pagar</title>
  <link rel="stylesheet" href="style.css"> 
  <link rel="stylesheet" href="estilo_entrega.css">
  <link rel="stylesheet" href="estilo_pagamento.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  </head>
<body>

     <header class="topbar">
      <nav class="actions">
        <div class="logo-container">
          <a href="index.html">
            <img src="imagens/exemplo-logo.png"" alt="Logo" style="width: 40px; height: 40px;">
          </a>
        </div>
        <div class="user-menu">
          <a href="#">Contato</a>
        </div>
      </nav>
    </header>

<main class="entrega-layout-container">
        
        <div class="opcoes-entrega">
            <h2>Escolha como pagar</h2>
            
            <form id="form-pagamento">
                
                <h4 class="subtitulo-pagamento">Recomendados</h4>

                <div class="opcao-bloco selecionado">
                    <input type="radio" id="linha-credito" name="forma-pagamento" value="linha-credito" checked>
                    <span class="icone-linha-credito">$</span> 
                    <label for="linha-credito" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Linha de Crédito</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Disponível: R$ 100,00</p>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="nubank" name="forma-pagamento" value="nubank">
                    <i class="fa-regular fa-credit-card icone-pagamento"></i>
                    <label for="nubank" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Cartão **** 1234</span>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="pix" name="forma-pagamento" value="pix">
                    <i class="fa-brands fa-pix icone-pagamento"></i>
                    <label for="pix" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Pix</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Aprovação imediata</p>
                        </div>
                    </label>
                </div>
                <h4 class="subtitulo-pagamento">Cartões</h4>

                <div class="opcao-bloco">
                    <input type="radio" id="novo-cartao" name="forma-pagamento" value="novo-cartao">
                    <i class="fa-regular fa-credit-card icone-pagamento"></i>
                    
                    <label for="novo-cartao" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Novo cartão de crédito</span>
                        </div>
                    
                        <div class="formulario-novo-cartao" id="formulario-novo-cartao">
                            
                            <div class="form-coluna-esquerda">
                                <div class="form-grupo" id="grupo-numero-cartao">
                                    <label for="numero-cartao">Número do cartão</label>
                                    <input type="text" id="numero-cartao" placeholder="1234 1234 1234 1234">
                                    <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>
                                
                                <div class="form-grupo" id="grupo-nome-titular">
                                    <label for="nome-titular">Nome do titular</label>
                                    <input type="text" id="nome-titular" placeholder="Ex.: Fulano Silva">
                                    <span class="helper-text">Conforme aparece no cartão.</span>
                                    <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>

                                <div class="form-linha">
                                    <div class="form-grupo" style="flex: 1;" id="grupo-vencimento">
                                        <label for="vencimento">Vencimento</label>
                                        <input type="text" id="vencimento" placeholder="MM/AA">
                                        <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                    </div>
                                    <div class="form-grupo" style="flex: 1;" id="grupo-cvv">
                                        <label for="cvv">Código de segurança <i class="fa-regular fa-circle-question" title="Os 3 dígitos atrás do cartão"></i></label>
                                        <input type="text" id="cvv" placeholder="Ex.: 123">
                                        <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                    </div>
                                </div>

                                <div class="form-grupo" id="grupo-documento">
                                    <label for="documento">Documento do titular</label>
                                    <div class="form-linha-documento">
                                        <select id="tipo-documento">
                                            <option value="CPF">CPF</option>
                                            <option value="CNPJ">CNPJ</option>
                                        </select>
                                        <input type="text" id="documento" placeholder="999.999.999-99" style="flex: 1;">
                                    </div>
                                     <span class="msg-erro-pagamento"><i class="fa-solid fa-circle-exclamation"></i> Preencha este campo.</span>
                                </div>
                            </div> 
                            <!-- Retirado -->
                            <!-- <div class="form-coluna-direita">
                                <img src="imagens/cartao-generico.png" alt="Cartão de crédito">
                            </div> -->

                        </div>
                    </label> </div>


                <h4 class="subtitulo-pagamento">Outros meios de pagamento</h4>
                
                <div class="opcao-bloco">
                    <input type="radio" id="boleto" name="forma-pagamento" value="boleto">
                    <i class="fa-solid fa-barcode icone-pagamento"></i>
                    <label for="boleto" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Boleto</span>
                        </div>
                        <div class="opcao-detalhes">
                            <p style="margin: 0;">Aprovação em 1 a 2 dias úteis</p>
                        </div>
                    </label>
                </div>
                
                <button type="button" class="btn-continuar-entrega">Continuar</button>
            </form>
        </div>

        
        <aside class="resumo-compra">
            <h3>Resumo da compra</h3>
            
            <div class="resumo-linha">
                <span>Produto</span>
                <span id="resumo-produto-valor">R$ 0,00</span>
            </div>
            
            <div class="resumo-linha">
                <span>Frete</span>
                <span id="resumo-frete-valor">R$ 0,00</span>
            </div>
            
            <a href="#" class="link-cupom">Inserir código do cupom</a>
            
            <div class="resumo-linha total">
                <span>Você pagará</span>
                <span id="resumo-total-valor">R$ 0,00</span>
            </div>
        </aside>

    </main>
    
    <div id="success-notification" class="notification success hidden">
        <i class="fas fa-check-circle notification-icon"></i>
        <span class="notification-message">Pagamento bem-sucedido! Gerando nota fiscal...</span>
        <button class="notification-close" aria-label="Fechar">&times;</button>
    </div>

    <script>
        // --- Função para gerar a Nota Fiscal (PDF) ---
        function gerarNotaFiscalPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const subtotal = localStorage.getItem("totalCompra") || "0.00";
            const frete = localStorage.getItem("valorFrete") || "0.00";
            const total = localStorage.getItem("valorFinal") || "0.00";
            const dataEmissao = new Date().toLocaleDateString('pt-BR');
            const fSubtotal = parseFloat(subtotal).toFixed(2).replace(".", ",");
            const fFrete = parseFloat(frete).toFixed(2).replace(".", ",");
            const fTotal = parseFloat(total).toFixed(2).replace(".", ",");

            const dadosEntregaJSON = localStorage.getItem('dadosEntrega');
            const fallbackEntrega = { tipo: 'endereco', nome: 'Fulano Silva', documento: '123.456.789-00', endereco: 'Exemplo Fictício, 123', bairro: 'Centro', cep: '13180-000', municipio: 'Hortolândia', uf: 'SP', fone: '(19) 99999-9999' };
            let entrega;
            try {
                entrega = dadosEntregaJSON ? JSON.parse(dadosEntregaJSON) : fallbackEntrega;
                if (!entrega.nome || !entrega.endereco) entrega = fallbackEntrega;
            } catch (e) {
                console.error("Erro ao ler dadosEntrega do localStorage:", e);
                entrega = fallbackEntrega;
            }

            const margemEsq = 10;
            const margemDir = 200;
            const colCentro = 105;
            let y = 70; // Posição inicial Y para a seção de entrega

            // --- Cabeçalho e Dados (Emitente/Destinatário) ---
            doc.setFontSize(18);
            doc.text("NOTA FISCAL", colCentro, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("DADOS DO EMITENTE", margemEsq, 35);
            doc.setFont("helvetica", "normal");
            doc.text("LOJA LTDA", margemEsq, 42);
            doc.text("CNPJ: 00.123.456/0001-78", margemEsq, 49);
            doc.text("Inscrição Estadual: 123.456.789.110", margemEsq, 56);
            doc.setFont("helvetica", "bold");
            doc.text("DADOS DO DESTINATÁRIO", colCentro, 35);
            doc.setFont("helvetica", "normal");
            doc.text(`Nome: ${entrega.nome || 'Não informado'}`, colCentro, 42); // Usando nome da entrega
            doc.text(`CPF/CNPJ: ${entrega.documento || 'Não informado'}`, colCentro, 49); // Usando doc da entrega
            doc.text("Inscrição Estadual: ISENTO", colCentro, 56);


            // --- INFORMAÇÕES DO LOCAL DE ENTREGA (DINÂMICO) ---
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            const tituloEntrega = entrega.tipo === 'agencia' ? "INFORMAÇÕES DO LOCAL DE RETIRADA (AGÊNCIA)" : "INFORMAÇÕES DO LOCAL DE ENTREGA / RETIRADA";
            doc.text(tituloEntrega, margemEsq, y);
            y += 3;

            // Caixas e Linhas da Seção de Entrega
            doc.rect(margemEsq, y, 190, 30); // Caixa externa
            doc.line(margemEsq, y + 10, margemDir, y + 10); // Linha horizontal 1
            doc.line(margemEsq, y + 20, margemDir, y + 20); // Linha horizontal 2
            doc.line(120, y, 120, y + 30); // Linha vertical 1 (depois de Nome/Endereço/Município)
            doc.line(160, y, 160, y + 30); // Linha vertical 2 (depois de CPF/Bairro/UF)

            // Títulos dos Campos da Seção de Entrega
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text("NOME/RAZÃO SOCIAL", margemEsq + 1, y + 3);
            doc.text("C.N.P.J / C.P.F.", 121, y + 3);
            doc.text("INSCRIÇÃO ESTADUAL", 161, y + 3);
            doc.text("ENDEREÇO", margemEsq + 1, y + 13);
            doc.text("BAIRRO/DISTRITO", 121, y + 13);
            doc.text("CEP", 161, y + 13);
            doc.text("MUNICÍPIO", margemEsq + 1, y + 23);
            doc.text("UF", 121, y + 23);
            doc.text("FONE/FAX", 161, y + 23);

            // Dados Dinâmicos da Seção de Entrega (com Truncamento)
            doc.setFontSize(10);
            const col1_largura = 109; // Largura da primeira coluna
            const col2_largura = 39;  // Largura da segunda coluna
            const col3_largura = 39;  // Largura da terceira coluna

            // LINHA 1
            let nomeSplit = doc.splitTextToSize(entrega.nome || '', col1_largura);
            doc.text(nomeSplit[0], margemEsq + 1, y + 7);
            let docSplit = doc.splitTextToSize(entrega.documento || '', col2_largura);
            doc.text(docSplit[0], 121, y + 7);
            doc.text("ISENTO", 161, y + 7); // Assumindo isento para IE de entrega

            // LINHA 2
            let enderecoSplit = doc.splitTextToSize(entrega.endereco || '', col1_largura);
            doc.text(enderecoSplit[0], margemEsq + 1, y + 17);
            let bairroSplit = doc.splitTextToSize(entrega.bairro || '', col2_largura);
            doc.text(bairroSplit[0], 121, y + 17);
            let cepSplit = doc.splitTextToSize(entrega.cep || '', col3_largura);
            doc.text(cepSplit[0], 161, y + 17);

            // LINHA 3
            let municipioSplit = doc.splitTextToSize(entrega.municipio || '', col1_largura);
            doc.text(municipioSplit[0], margemEsq + 1, y + 27);
            doc.text(entrega.uf || '', 121, y + 27);
            let foneSplit = doc.splitTextToSize(entrega.fone || '', col3_largura);
            doc.text(foneSplit[0], 161, y + 27);

            y += 35; // Avança Y para a próxima seção

            // --- Descrição dos Produtos ---
            doc.setFont("helvetica", "bold");
            doc.text("DESCRIÇÃO DOS PRODUTOS", margemEsq, y);
            y += 5;
            doc.setFont("helvetica", "normal");
            // Cabeçalhos da tabela de produtos
            doc.text("Qtd.", margemEsq, y);
            doc.text("Un.", margemEsq + 15, y);
            doc.text("Descrição", margemEsq + 30, y);
            doc.text("Valor Unit.", margemEsq + 140, y, { align: 'right' }); // Alinhado à direita
            doc.text("Valor Total", margemEsq + 170, y, { align: 'right' }); // Alinhado à direita
            doc.line(margemEsq, y + 2, margemDir, y + 2); // Linha abaixo dos cabeçalhos
            y += 7;
            // Linha do Produto
            doc.text("1", margemEsq, y);
            doc.text("UN", margemEsq + 15, y);
            doc.text("Produto Exemplo Comprado no Site", margemEsq + 30, y);
            doc.text(fSubtotal, margemEsq + 140, y, { align: 'right' });
            doc.text(fSubtotal, margemEsq + 170, y, { align: 'right' });
            y += 7;
            // Linha do Frete (se houver)
            if (parseFloat(frete) > 0) {
                 doc.text("1", margemEsq, y);
                 doc.text("UN", margemEsq + 15, y);
                 doc.text("Serviço de Entrega (Frete)", margemEsq + 30, y);
                 doc.text(fFrete, margemEsq + 140, y, { align: 'right' });
                 doc.text(fFrete, margemEsq + 170, y, { align: 'right' });
                 y += 7;
            }
             y += 3; // Espaço antes da próxima seção

            // --- CÁLCULO DO IMPOSTO ---
            doc.setFont("helvetica", "bold");
            doc.text("CÁLCULO DO IMPOSTO", margemEsq, y);
            y += 3;
            // Caixas e Linhas da Seção de Imposto
            doc.rect(margemEsq, y, 190, 20); // Caixa externa
            doc.line(margemEsq, y + 10, margemDir, y + 10); // Linha horizontal
            // Linhas verticais da primeira linha de títulos
            doc.line(48, y, 48, y + 10);
            doc.line(73, y, 73, y + 10);
            doc.line(145, y, 145, y + 10);
            // Linhas verticais da segunda linha de títulos
            doc.line(48, y + 10, 48, y + 20);
            doc.line(74, y + 10, 74, y + 20);
            doc.line(105, y + 10, 105, y + 20);
            doc.line(159, y + 10, 159, y + 20);
            // Títulos dos Campos da Seção de Imposto
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            // Primeira linha de títulos
            doc.text("BASE DE CÁLCULO DO ICMS", margemEsq + 1, y + 3);
            doc.text("VALOR DO ICMS", 49, y + 3);
            doc.text("BASE DE CÁLCULO DO ICMS SUBSTITUIÇÃO", 74, y + 3);
            doc.text("VALOR TOTAL DOS PRODUTOS", 146, y + 3);
            // Segunda linha de títulos
            doc.text("VALOR DO FRETE", margemEsq + 1, y + 13);
            doc.text("VALOR DO SEGURO", 49, y + 13);
            doc.text("DESCONTO", 75, y + 13);
            doc.text("OUTRAS DESPESAS ACESSÓRIAS", 106, y + 13);
            doc.text("VALOR TOTAL DA NOTA", 160, y + 13);
            // Valores da Seção de Imposto
            doc.setFontSize(10);
            // Primeira linha de valores (alinhados à direita antes da linha vertical)
            doc.text("0,00", 47, y + 7, { align: 'right' });
            doc.text("0,00", 72, y + 7, { align: 'right' });
            doc.text("0,00", 144, y + 7, { align: 'right' });
            doc.text(fSubtotal, 199, y + 7, { align: 'right' }); // Total Produtos
            // Segunda linha de valores
            doc.text(fFrete, 47, y + 17, { align: 'right' }); // Valor Frete
            doc.text("0,00", 72, y + 17, { align: 'right' });
            doc.text("0,00", 104, y + 17, { align: 'right' });
            doc.text("0,00", 158, y + 17, { align: 'right' });
            doc.text(fTotal, 199, y + 17, { align: 'right' }); // Valor Total Nota
            y += 25; // Avança Y para a próxima seção

            // --- Datas ---
            doc.setFont("helvetica", "bold");
            doc.text("Data de Emissão:", margemEsq, y);
            doc.setFont("helvetica", "normal");
            doc.text(dataEmissao, margemEsq + 35, y);
            doc.setFont("helvetica", "bold");
            doc.text("Data de Saída:", colCentro, y);
            doc.setFont("helvetica", "normal");
            doc.text(dataEmissao, colCentro + 30, y); // Usando a mesma data por exemplo

            // --- Salva o arquivo ---
            doc.save("nota_fiscal_simulada.pdf");
        }

        // --- Variáveis Globais para Notificação ---
        let notificationTimeout; // Guarda a referência do timeout

        // --- Funções para Notificação ---
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('success-notification');
            if (!notification) {
                console.error("Elemento de notificação não encontrado!");
                return;
            }
            const messageSpan = notification.querySelector('.notification-message');
            if (!messageSpan) {
                console.error("Elemento de mensagem da notificação não encontrado!");
                return;
            }

            clearTimeout(notificationTimeout); // Limpa timeout anterior se houver

            messageSpan.textContent = message;
            notification.className = 'notification hidden'; // Reseta classes
            notification.classList.add(type);
            notification.style.display = 'flex'; // Garante que está visível antes de animar
            // Força reflow para garantir que a transição ocorra
            void notification.offsetWidth;
            notification.classList.remove('hidden');
            notification.classList.add('show');

            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, duration);

            const closeButton = notification.querySelector('.notification-close');
            if (closeButton) {
                 // Remove listener antigo para evitar duplicação
                 closeButton.removeEventListener('click', hideNotification);
                 // Adiciona novo listener
                 closeButton.addEventListener('click', hideNotification);
            }
        }

        function hideNotification() {
            const notification = document.getElementById('success-notification');
             if (!notification) return;

            clearTimeout(notificationTimeout);
            notification.classList.remove('show');
             // Adiciona 'hidden' após a transição CSS para poder usar display: none se necessário
             // (o CSS atual usa visibility/opacity, então não é estritamente necessário)
             setTimeout(() => {
                 notification.classList.add('hidden');
                 notification.style.display = 'none'; // Esconde após animação
             }, 400); // Deve ser igual à duração da transição no CSS (0.4s)
        }


        // --- Código que Roda Após Carregar o DOM ---
        document.addEventListener("DOMContentLoaded", function() {

            // --- Funções Auxiliares (Formatação) ---
            function formatarMoeda(valorStr) {
                const numero = parseFloat(valorStr);
                if (isNaN(numero)) return "R$ 0,00";
                return "R$ " + numero.toFixed(2).replace(".", ",");
            }
            function formatarFrete(valorStr) {
                const numero = parseFloat(valorStr);
                if (isNaN(numero) || numero === 0) return "GRÁTIS";
                return formatarMoeda(valorStr);
            }

            // --- Carregamento Inicial do Resumo ---
            const subtotal = localStorage.getItem("totalCompra");
            const frete = localStorage.getItem("valorFrete");
            const totalFinal = localStorage.getItem("valorFinal");
            const elProduto = document.getElementById("resumo-produto-valor");
            const elFrete = document.getElementById("resumo-frete-valor");
            const elTotal = document.getElementById("resumo-total-valor");

            if (elProduto && subtotal !== null) elProduto.innerText = formatarMoeda(subtotal);
            if (elFrete && frete !== null) {
                elFrete.innerText = formatarFrete(frete);
                elFrete.classList.toggle("preco-gratis", parseFloat(frete) === 0);
            }
            if (elTotal && totalFinal !== null) elTotal.innerText = formatarMoeda(totalFinal);

            // --- Referências aos Elementos do Formulário ---
            const formNovoCartao = document.getElementById('formulario-novo-cartao');
            const radioNovoCartao = document.getElementById('novo-cartao');
            const radioLinhaCredito = document.getElementById('linha-credito');
            const radioPix = document.getElementById('pix');
            const radioBoleto = document.getElementById('boleto');
            const radioNubank = document.getElementById('nubank');
            // Inputs e Grupos do Cartão
            const grupoNumero = document.getElementById('grupo-numero-cartao');
            const grupoNome = document.getElementById('grupo-nome-titular');
            const grupoVencimento = document.getElementById('grupo-vencimento');
            const grupoCvv = document.getElementById('grupo-cvv');
            const grupoDocumento = document.getElementById('grupo-documento');
            const inputNumero = document.getElementById('numero-cartao');
            const inputNome = document.getElementById('nome-titular');
            const inputVencimento = document.getElementById('vencimento');
            const inputCvv = document.getElementById('cvv');
            const inputDocumento = document.getElementById('documento');
            const selectTipoDocumento = document.getElementById('tipo-documento');
            const btnContinuarPagina = document.querySelector('.btn-continuar-entrega');

            // --- Lógica das Máscaras de Input ---
            if (inputNumero) {
                inputNumero.setAttribute('maxlength', '19'); // 16 digitos + 3 espaços
                inputNumero.addEventListener('input', (e) => {
                    let valor = e.target.value.replace(/\D/g, '').substring(0, 16);
                    e.target.value = valor.replace(/(\d{4})(?=\d)/g, '$1 '); // Adiciona espaço a cada 4 dígitos
                });
            }
            if (inputVencimento) {
                 inputVencimento.setAttribute('maxlength', '5'); // MM/AA
                 inputVencimento.addEventListener('input', (e) => {
                     let valor = e.target.value.replace(/\D/g, '').substring(0, 4);
                     if (valor.length > 2) valor = valor.substring(0, 2) + '/' + valor.substring(2);
                     e.target.value = valor;
                 });
            }
             if (inputCvv) {
                 inputCvv.setAttribute('maxlength', '4'); // Alguns cartões têm 4 dígitos
                 inputCvv.addEventListener('input', (e) => {
                     e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
                 });
            }
             if (inputDocumento && selectTipoDocumento) {
                 const aplicarMascaraDocumento = () => {
                     let valor = inputDocumento.value.replace(/\D/g, '');
                     const tipo = selectTipoDocumento.value;
                     if (tipo === 'CPF') {
                         inputDocumento.placeholder = '000.000.000-00';
                         inputDocumento.setAttribute('maxlength', '14');
                         valor = valor.substring(0, 11);
                         valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                         valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                         valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                     } else { // CNPJ
                         inputDocumento.placeholder = '00.000.000/0000-00';
                         inputDocumento.setAttribute('maxlength', '18');
                         valor = valor.substring(0, 14);
                         valor = valor.replace(/(\d{2})(\d)/, '$1.$2');
                         valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
                         valor = valor.replace(/(\d{3})(\d)/, '$1/$2');
                         valor = valor.replace(/(\d{4})(\d)/, '$1-$2');
                     }
                     inputDocumento.value = valor;
                 };
                 inputDocumento.addEventListener('input', aplicarMascaraDocumento);
                 selectTipoDocumento.addEventListener('change', () => {
                     inputDocumento.value = ''; // Limpa ao trocar o tipo
                     aplicarMascaraDocumento(); // Aplica placeholder e maxlength corretos
                 });
                 // Define placeholder inicial
                 aplicarMascaraDocumento();
             }

            // --- Lógica de Seleção dos Blocos e Exibição do Formulário ---
            document.querySelectorAll('input[name="forma-pagamento"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Atualiza a classe 'selecionado' em todos os blocos
                    document.querySelectorAll('.opcao-bloco').forEach(bloco => {
                        const inputInterno = bloco.querySelector('input[name="forma-pagamento"]');
                        bloco.classList.toggle('selecionado', inputInterno && inputInterno.checked);
                    });

                    // Mostra ou esconde o formulário de novo cartão
                    if (formNovoCartao) {
                         formNovoCartao.style.display = radioNovoCartao && radioNovoCartao.checked ? 'flex' : 'none';
                         if (!(radioNovoCartao && radioNovoCartao.checked)) {
                             resetarErrosCartao(); // Limpa erros se esconder o form
                         }
                    }
                });
            });
             // Garante estado inicial correto do formulário de cartão
             if (formNovoCartao) {
                 formNovoCartao.style.display = radioNovoCartao && radioNovoCartao.checked ? 'flex' : 'none';
             }

            // --- Funções de Validação e Reset ---
            function validarFormularioCartao() {
                let isValid = true;
                resetarErrosCartao(); // Limpa erros antigos
                const campos = [
                    { input: inputNumero, grupo: grupoNumero, minLength: 19 }, // 16 digitos + 3 espaços
                    { input: inputNome, grupo: grupoNome },
                    { input: inputVencimento, grupo: grupoVencimento, minLength: 5 }, // MM/AA
                    { input: inputCvv, grupo: grupoCvv, minLength: 3 },
                    { input: inputDocumento, grupo: grupoDocumento, minLength: (selectTipoDocumento.value === 'CPF' ? 14 : 18) }
                ];

                campos.forEach(campo => {
                     if (!campo.input || !campo.grupo) return; // Pula se elemento não existe

                     const valor = campo.input.value.trim();
                     let invalido = valor === '';
                     if (campo.minLength && valor.length < campo.minLength) {
                         invalido = true;
                     }
                     // Adicionar validações mais específicas aqui se necessário (ex: data de vencimento válida)

                     if (invalido) {
                         campo.grupo.classList.add('campo-com-erro');
                         isValid = false;
                     }
                });
                return isValid;
            }

            function resetarErrosCartao() {
                const grupos = [grupoNumero, grupoNome, grupoVencimento, grupoCvv, grupoDocumento];
                grupos.forEach(grupo => {
                    if (grupo) grupo.classList.remove('campo-com-erro');
                });
            }

            // --- Lógica do Botão "Continuar" (Principal) ---
            if (btnContinuarPagina) {
                btnContinuarPagina.addEventListener('click', function() {
                    let pagamentoSucesso = false; // Flag para controlar se o pagamento foi OK
                    const radioSelecionado = document.querySelector('input[name="forma-pagamento"]:checked');

                    if (!radioSelecionado) {
                        alert("Por favor, selecione um método de pagamento.");
                        return; // Sai da função se nada estiver selecionado
                    }

                    const metodoPagamento = radioSelecionado.value;

                    switch(metodoPagamento) {
                        case 'novo-cartao':
                            if (validarFormularioCartao()) {
                                console.log("Pagamento (com novo cartão) validado!");
                                pagamentoSucesso = true;
                            } else {
                                console.log("Formulário de cartão inválido. Por favor, corrija os campos.");
                            }
                            break;
                        case 'nubank': // Assumindo 'nubank' como o value do cartão salvo
                            console.log("Pagamento (com cartão salvo) selecionado.");
                            pagamentoSucesso = true;
                            break;
                        case 'linha-credito':
                        case 'pix':
                        case 'boleto':
                            console.log(`Método de pagamento '${metodoPagamento}' selecionado.`);
                            pagamentoSucesso = true;
                            break;
                        default:
                             console.warn("Método de pagamento desconhecido:", metodoPagamento);
                             alert("Método de pagamento inválido selecionado.");
                    }

                    // Se o pagamento foi considerado bem-sucedido
                    if (pagamentoSucesso) {
                        // 1. Define a duração da notificação + animação
                        const notificationDuration = 3000; // Tempo que a notificação fica visível
                        const animationDuration = 400;  // Tempo da animação de saída (do CSS transition)
                        const totalDelay = notificationDuration + animationDuration;

                        // 2. Mostra a notificação
                        showNotification("Pagamento bem-sucedido! Gerando nota fiscal...", 'success', notificationDuration);

                        // 3. Agenda a geração do PDF para DEPOIS que a notificação sumir
                        console.log(`Agendando geração do PDF para daqui a ${totalDelay}ms.`);
                        setTimeout(gerarNotaFiscalPDF, totalDelay); // <-- SUBSTITUIÇÃO APLICADA

                    }
                });
            } else {
                 console.error("Botão '.btn-continuar-entrega' não encontrado.");
            }

        }); // <-- FIM do DOMContentLoaded
    </script>
    </body>
</html>