<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forma de Entrega</title>
  <link rel="stylesheet" href="estilo_entrega.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>

     <header class="topbar-entrega">
      <nav class="actions-entrega">
        <div class="logo-container">
          <a href="index.html">
            <img src="imagens/exemplo-logo.png" alt="Logo" class="logo">
          </a>
        </div>
        <div class="user-menu">
          <a href="#">
            <i class="fa-regular fa-user"></i>
            Usuarío
            <i class="fa-solid fa-chevron-down"></i>
          </a>
          <a href="#">Contato</a>
        </div>
      </nav>
    </header>

    <main class="entrega-layout-container">
        
        <div class="opcoes-entrega">
            <h2>Escolha a forma de entrega</h2>
            
            <form id="form-entrega">
                <div class="opcao-bloco selecionado">
                    <input type="radio" id="enviar-endereco" name="forma-entrega" value="endereco" checked>
                    <label for="enviar-endereco" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Enviar no meu endereço</span>
                            <span class="preco-gratis">Grátis</span>
                        </div>
                        
                        <div class="opcao-detalhes">
                            <p style="font-weight: 600; font-size: 15px;">Exemplo Fictício, 123 - Centro</p>
                            <p style="margin: 5px 0;">13180-000 - Hortolândia - SP</p>
                            <p class="tipo-endereco">Recebe: Fulano de Tal</p>
                            <a href="#" class="link-acao" onclick="mostrarModal('modal-editar-endereco')">Alterar ou escolher outro endereço</a>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="retirar-agencia" name="forma-entrega" value="agencia">
                    <label for="retirar-agencia" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Retirada na Agência</span>
                            <span class="preco">R$ 7,99</span>
                        </div>
                        
                        <div class="opcao-detalhes" id="detalhes-agencia-selecionada">
                            <p class="distancia">A 450 m do seu endereço</p>
                            <p>Agência - LOJA 1 - (Centro)</p>
                            <p>Segunda à sexta das 9 às 17:30 hs. - Sábado das 9 às 15 hs.</p>
                            <a href="#" class="link-acao" onclick="mostrarModal('modal-retirar-agencia')">Ver agência no mapa ou selecionar outra</a>
                        </div>
                    </label>
                </div>
                
                <button type="button" class="btn-continuar-entrega">Continuar</button>
            </form>
        </div>

        <aside class="resumo-compra">
            <h3>Resumo da compra</h3>
            <div class="resumo-linha">
                <span>Produto</span>
                <span id="resumo-produto-preco">R$ 0,00</span>
            </div>
            <div class="resumo-linha">
                <span>Frete</span>
                <span id="resumo-frete-preco" class="preco-gratis">GRÁTIS</span>
            </div>
            <div class="resumo-divisor" style="display: block;"></div>
            <div class="resumo-linha total">
                <span>Total</span>
                <span id="resumo-total-preco">R$ 0,00</span>
            </div>
        </aside>

    </main>

    <div class="modal-overlay" id="modal-editar-endereco" onclick="fecharModal('modal-editar-endereco')">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <button class="modal-fechar" onclick="fecharModal('modal-editar-endereco')"><i class="fa-solid fa-xmark"></i></button>
            <h3>Editar endereço</h3>
            
            <form class="form-modal">
                <div class="form-grupo">
                    <label for="cep">CEP</label>
                    <input type="text" id="cep" placeholder="Ex.: 13184-000">
                    <a href="#" class="link-form">Não sei meu CEP</a>
                </div>
                
                <div class="form-linha">
                    <div class="form-grupo" style="flex: 2;">
                        <label for="rua">Rua / Avenida</label>
                        <input type="text" id="rua" placeholder="Ex.: Avenida Los Leones, 4563">
                        <span class="msg-erro" id="erro-rua" style="display: none;">Você deve inserir o nome da rua.</span>
                    </div>
                    <div class="form-grupo" style="flex: 1;">
                        <label for="numero">Número</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="numero" placeholder="Ex.: 45607052" style="flex: 1; min-width: 50px;">
                        <div class="checkbox-container" style="white-space: nowrap;">
                            <input type="checkbox" id="sem-numero">
                            <label for="sem-numero">Sem número</label>
                        </div>
                    </div>
                </div>
                </div>

                <div class="form-grupo">
                    <label for="complemento">Complemento (opcional)</label>
                    <input type="text" id="complemento" placeholder="Ex.: 201">
                </div>

                <div class="form-grupo">
                    <label for="info-adicional">Informações adicionais deste endereço (opcional)</label>
                    <textarea id="info-adicional" placeholder="Ex.: Entre ruas, cor do edifício, não tem campainha." maxlength="128"></textarea>
                    <span class="char-contador">0 / 128</span>
                </div>

                <div class="form-grupo">
                    <p>Este é o seu trabalho ou sua casa?</p>
                    <div class="radio-grupo">
                        <input type="radio" id="casa" name="tipo-local" checked>
                        <label for="casa"><i class="fa-solid fa-house"></i> Casa</label>
                    </div>
                    <div class="radio-grupo">
                        <input type="radio" id="trabalho" name="tipo-local">
                        <label for="trabalho"><i class="fa-solid fa-briefcase"></i> Trabalho</label>
                    </div>
                </div>

                <div class="form-grupo">
                    <p>Dados de contato</p>
                    <span>Se houver algum problema no envio, você receberá uma ligação neste número.</span>
                    <label for="nome" style="margin-top: 10px;">Nome e sobrenome</label>
                    <input type="text" id="nome"> <span class="msg-erro" id="erro-nome" style="display: none;">Você deve inserir nome e sobrenome.</span>
                </div>

                <div class="form-grupo" style="margin-top: 15px;">
                    <button type="button" id="btn-salvar-endereco" class="btn-continuar-entrega">Ok</button>
                </div>

            </form>
        </div>
    </div>
    <div class="modal-overlay" id="modal-retirar-agencia" onclick="fecharModal('modal-retirar-agencia')">
        <div class="modal-conteudo modal-grande" onclick="event.stopPropagation()">
            <button class="modal-fechar" onclick="fecharModal('modal-retirar-agencia')"><i class="fa-solid fa-xmark"></i></button>
            <h3>Selecione um ponto de retirada</h3>
            <span class="subtitulo-modal">A agência deve estar localizada no mesmo estado do seu endereço de faturamento.</span>

            <div class="form-grupo" style="margin-top: 15px;">
                <input type="search" id="busca-local" placeholder="Busque uma localização">
            </div>

            <div class="retirada-layout">
                <div class="lista-agencias">
                    <span class="resultado-busca">Mostrando 15 resultados</span>
                    <div class="agencia-item">
                        <h4>LOJA 1</h4>
                        <p>Agência</p>
                        <p><i class="fa-solid fa-location-dot"></i> RUA LUIZ CAMILO DE CAMARGO, 581, Centro, Hortolândia (13184-230) - a 0 m</p>
                        <p><i class="fa-regular fa-clock"></i> Segunda à sexta das 9 às 17:30 hs. - Sábado das 9 às 15 hs.</p>
                        <div class="agencia-footer">
                            <span>Chegará na agência quarta-feira <strong>R$ 5,99</strong></span>
                            <button class="btn-escolher">Escolher</button>
                        </div>
                    </div>
                    <div class="agencia-item">
                        <h4>PONTO EXTRA HORTOLÂNDIA</h4>
                        <p>Agência</p>
                        <p><i class="fa-solid fa-location-dot"></i> AV. DA EMACIPAÇÃO, 1200, Jardim Santa Rita de Cássia, Hortolândia (13186-505) - a 1,2 km</p>
                        <p><i class="fa-regular fa-clock"></i> Segunda à sábado das 8 às 18:30 hs. - Segunda à sábado das 14:30 às 18 hs. - Domingo das 8 às 12 hs.</p>
                        <div class="agencia-footer">
                            <span>Chegará na agência quarta-feira <strong>R$ 5,99</strong></span>
                            <button class="btn-escolher">Escolher</button>
                        </div>
                    </div>
                </div>
                <div class="mapa-container">
                    <div id="mapa"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Variável global para guardar o subtotal vindo do carrinho ---
        let subtotalCompra = 0.0;
        
        // --- NOVO: Variável global para guardar o objeto do mapa (começa nula) ---
        let map = null; 

        // --- Funções para controlar os Modais (Subtelas) ---
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            if (modalId === 'modal-retirar-agencia' && !map) {
                // ... (Todo o seu código de inicialização do mapa - está correto) ...
                const locais = [
                    { 
                        nome: 'LOJA 1',
                        endereco: 'RUA LUIZ CAMILO DE CAMARGO, 581, Centro, Hortolândia (13184-230)',
                        coords: { lat: -22.85848, lng: -47.22129 }
                    },
                    { 
                        nome: 'PONTO EXTRA HORTOLÂNDIA',
                        endereco: 'AV. DA EMACIPAÇÃO, 1200, Jardim Santa Rita de Cássia, Hortolândia (13186-505)',
                        coords: { lat: -22.86985, lng: -47.21461 }
                    }
                ];
                const centroDoMapa = [-22.864, -47.218]; 
                map = L.map('mapa').setView(centroDoMapa, 14); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                locais.forEach(local => {
                    L.marker([local.coords.lat, local.coords.lng]) 
                     .addTo(map)
                     .bindPopup(`<b>${local.nome}</b><br>${local.endereco}`);
                });
            }
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // --- FUNÇÃO: Atualiza o Resumo da Compra ---
        function atualizarResumoEntrega() {
            // ... (Seu código de atualização de resumo - está correto) ...
            const freteSelecionado = document.querySelector('input[name="forma-entrega"]:checked').value;
            const freteSpan = document.getElementById("resumo-frete-preco");
            let valorFrete = 0.0;
            let textoFrete = "GRÁTIS";
            if (freteSelecionado === 'agencia') {
                valorFrete = 7.99;
                textoFrete = "R$ 7,99";
                freteSpan.classList.remove("preco-gratis");
            } else {
                valorFrete = 0.0;
                textoFrete = "GRÁTIS";
                freteSpan.classList.add("preco-gratis");
            }
            const valorTotal = subtotalCompra + valorFrete;
            document.getElementById("resumo-produto-preco").innerText = "R$ " + subtotalCompra.toFixed(2).replace(".", ",");
            freteSpan.innerText = textoFrete;
            document.getElementById("resumo-total-preco").innerText = "R$ " + valorTotal.toFixed(2).replace(".", ",");
        }


        // --- Lógica para selecionar as opções de entrega ---
        document.querySelectorAll('input[name="forma-entrega"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // ... (Seu código de seleção de rádio - está correto) ...
                document.querySelectorAll('.opcao-bloco').forEach(bloco => {
                    bloco.classList.remove('selecionado');
                });
                if (this.checked) {
                    this.closest('.opcao-bloco').classList.add('selecionado');
                }
                atualizarResumoEntrega();
            });
        });

        // --- Roda quando a página carrega ---
        document.addEventListener("DOMContentLoaded", () => {
            // 1. Pega o valor total salvo no localStorage
            const totalSalvo = localStorage.getItem("totalCompra");
            
            // 2. Se existir, atualiza a variável global 'subtotalCompra'
            if (totalSalvo) {
                subtotalCompra = parseFloat(totalSalvo);
            }
            
            // 3. Roda a função de atualização para mostrar os valores corretos
            atualizarResumoEntrega();

            // --- BLOCO 1: LÓGICA PARA "ESCOLHER" UMA AGÊNCIA ---
            document.querySelectorAll('.btn-escolher').forEach(button => {
                button.addEventListener('click', (e) => {
                    
                    const itemAgencia = e.target.closest('.agencia-item');
                    const nomeAgencia = itemAgencia.querySelector('h4').innerText;
                    const horarioAgencia = itemAgencia.querySelector('i.fa-regular.fa-clock').parentElement.innerText;
                    const targetDetalhes = document.getElementById('detalhes-agencia-selecionada');
                    
                    targetDetalhes.innerHTML = `
                        <p style="font-weight: 600; font-size: 15px;">${nomeAgencia}</p>
                        <p style="margin: 5px 0;">${horarioAgencia}</p>
                        <a href="#" class="link-acao" onclick="mostrarModal('modal-retirar-agencia')">Ver agência no mapa ou selecionar outra</a>
                    `;

                    const radioAgencia = document.getElementById('retirar-agencia');
                    radioAgencia.checked = true;
                    radioAgencia.dispatchEvent(new Event('change'));
                    
                    // Fecha o modal de agência
                    fecharModal('modal-retirar-agencia');
                });
            });
            // --- FIM DO BLOCO 1 ---

            
            // --- BLOCO 2: LÓGICA DE VALIDAÇÃO DO MODAL DE ENDEREÇO ---
            // (Este é o bloco que foi movido para fora do Bloco 1)
            const btnSalvarEndereco = document.getElementById('btn-salvar-endereco');
            const inputRua = document.getElementById('rua');
            const erroRua = document.getElementById('erro-rua');
            const inputNome = document.getElementById('nome');
            const erroNome = document.getElementById('erro-nome');

            btnSalvarEndereco.addEventListener('click', () => {
                let isValid = true; 

                // 1. Limpa erros anteriores
                erroRua.style.display = 'none';
                inputRua.classList.remove('input-erro');
                erroNome.style.display = 'none';
                inputNome.classList.remove('input-erro');

                // 2. Valida o campo "Rua"
                if (inputRua.value.trim() === '') {
                    erroRua.style.display = 'block'; 
                    inputRua.classList.add('input-erro'); 
                    isValid = false;
                }

                // 3. Valida o campo "Nome"
                if (inputNome.value.trim() === '') {
                    erroNome.style.display = 'block'; 
                    inputNome.classList.add('input-erro'); 
                    isValid = false;
                }

                // 4. Se tudo estiver válido, fecha o modal
                if (isValid) {
                    fecharModal('modal-editar-endereco');
                }
            });
            // --- FIM DO BLOCO 2 ---

        }); // <-- Fim do DOMContentLoaded

    </script>
</body>
</html>