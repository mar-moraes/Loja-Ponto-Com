<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forma de Entrega</title>
  <link rel="stylesheet" href="estilo_entrega.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>

     <header class="topbar-entrega">
      <nav class="actions-entrega">
        <div class="logo-container">
          <a href="index.html">
            <img src="imagens/exemplo-logo.png" alt="Logo" class="logo">
          </a>
        </div>
        <div class="user-menu">
          <a href="#">
            <i class="fa-regular fa-user"></i>
            Usuarío
            <i class="fa-solid fa-chevron-down"></i>
          </a>
          <a href="#">Contato</a>
        </div>
      </nav>
    </header>

    <main class="entrega-layout-container">
        
        <div class="opcoes-entrega">
            <h2>Escolha a forma de entrega</h2>
            
            <form id="form-entrega">
                <div class="opcao-bloco selecionado">
                    <input type="radio" id="enviar-endereco" name="forma-entrega" value="endereco" checked>
                    <label for="enviar-endereco" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Enviar no meu endereço</span>
                            <span class="preco-gratis">Grátis</span>
                        </div>
                        
                        <div class="opcao-detalhes">
                            <p style="font-weight: 600; font-size: 15px;">Exemplo Fictício, 123 - Centro</p>
                            <p style="margin: 5px 0;">13180-000 - Hortolândia - SP</p>
                            <p class="tipo-endereco">Recebe: Fulano de Tal</p>
                            <a href="#" class="link-acao" onclick="mostrarModal('modal-editar-endereco')">Alterar ou escolher outro endereço</a>
                        </div>
                    </label>
                </div>

                <div class="opcao-bloco">
                    <input type="radio" id="retirar-agencia" name="forma-entrega" value="agencia">
                    <label for="retirar-agencia" class="opcao-label">
                        <div class="opcao-titulo">
                            <span>Retirada na Agência</span>
                            <span class="preco">R$ 5,99</span>
                        </div>
                        
                        <div class="opcao-detalhes" id="detalhes-agencia-selecionada">
                            <p class="distancia">A 450 m do seu endereço</p>
                            <p>Agência - LOJA 1 - (Centro)</p>
                            <p>Segunda à sexta das 9 às 17:30 hs. - Sábado das 9 às 15 hs.</p>
                            <a href="#" class="link-acao" onclick="mostrarModal('modal-retirar-agencia')">Ver agência no mapa ou selecionar outra</a>
                        </div>
                    </label>
                </div>
                
                <button type="button" class="btn-continuar-entrega">Continuar</button>
            </form>
        </div>

        <aside class="resumo-compra">
            <h3>Resumo da compra</h3>
            <div class="resumo-linha">
                <span>Produto</span>
                <span id="resumo-produto-preco">R$ 0,00</span>
            </div>
            <div class="resumo-linha">
                <span>Frete</span>
                <span id="resumo-frete-preco" class="preco-gratis">GRÁTIS</span>
            </div>
            <div class="resumo-divisor" style="display: block;"></div>
            <div class="resumo-linha total">
                <span>Total</span>
                <span id="resumo-total-preco">R$ 0,00</span>
            </div>
        </aside>

    </main>

    <div class="modal-overlay" id="modal-editar-endereco" onclick="fecharModal('modal-editar-endereco')">
        <div class="modal-conteudo" onclick="event.stopPropagation()">
            <button class="modal-fechar" onclick="fecharModal('modal-editar-endereco')"><i class="fa-solid fa-xmark"></i></button>
            <h3>Editar endereço</h3>
            
            <form class="form-modal">
                <div class="form-grupo">
                    <label for="cep">CEP</label>
                    <input type="text" id="cep" placeholder="Ex.: 13184-000">
                    <a href="#" class="link-form">Não sei meu CEP</a>
                </div>
                
                <div class="form-linha">
                    <div class="form-grupo" style="flex: 2;">
                        <label for="rua">Rua / Avenida</label>
                        <input type="text" id="rua" placeholder="Ex.: Avenida Los Leones, 4563">
                        <span class="msg-erro" id="erro-rua" style="display: none;">Você deve inserir o nome da rua.</span>
                    </div>
                    <div class="form-grupo" style="flex: 1;">
                        <label for="numero">Número</label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="numero" placeholder="Ex.: 45607052" style="flex: 1; min-width: 50px;">
                        <div class="checkbox-container" style="white-space: nowrap;">
                            <input type="checkbox" id="sem-numero">
                            <label for="sem-numero">Sem número</label>
                        </div>
                    </div>
                </div>
                </div>

                <div class="form-grupo">
                    <label for="complemento">Complemento (opcional)</label>
                    <input type="text" id="complemento" placeholder="Ex.: 201">
                </div>

                <div class="form-grupo">
                    <label for="info-adicional">Informações adicionais deste endereço (opcional)</label>
                    <textarea id="info-adicional" placeholder="Ex.: Entre ruas, cor do edifício, não tem campainha." maxlength="128"></textarea>
                    <span class="char-contador">0 / 128</span>
                </div>

                <div class="form-grupo">
                    <p>Este é o seu trabalho ou sua casa?</p>
                    <div class="radio-grupo">
                        <input type="radio" id="casa" name="tipo-local" checked>
                        <label for="casa"><i class="fa-solid fa-house"></i> Casa</label>
                    </div>
                    <div class="radio-grupo">
                        <input type="radio" id="trabalho" name="tipo-local">
                        <label for="trabalho"><i class="fa-solid fa-briefcase"></i> Trabalho</label>
                    </div>
                </div>

                <div class="form-grupo">
                    <p>Dados de contato</p>
                    <span>Se houver algum problema no envio, você receberá uma ligação neste número.</span>
                    <label for="nome" style="margin-top: 10px;">Nome e sobrenome</label>
                    <input type="text" id="nome"> <span class="msg-erro" id="erro-nome" style="display: none;">Você deve inserir nome e sobrenome.</span>
                </div>

                <div class="form-grupo" style="margin-top: 15px;">
                    <button type="button" id="btn-salvar-endereco" class="btn-continuar-entrega">Ok</button>
                </div>

            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal-retirar-agencia" onclick="fecharModal('modal-retirar-agencia')">
        <div class="modal-conteudo modal-grande" onclick="event.stopPropagation()">
            <button class="modal-fechar" onclick="fecharModal('modal-retirar-agencia')"><i class="fa-solid fa-xmark"></i></button>
            <h3>Selecione um ponto de retirada</h3>
            <span class="subtitulo-modal">A agência deve estar localizada no mesmo estado do seu endereço de faturamento.</span>

            <div class="form-grupo form-grupo-com-icone" style="margin-top: 15px;">
                <input type="search" id="busca-local" placeholder="Busque uma localização (Ex: Av. Paulista, São Paulo)">
                <i class="fa-solid fa-magnifying-glass icone-busca" id="btn-busca-local"></i>
            </div>

            <div class="retirada-layout">
                <div class="lista-agencias">
                    <span class="resultado-busca">Mostrando 15 resultados</span>
                    <div class="agencia-item">
                        <h4>LOJA 1</h4>
                        <p>Agência</p>
                        <p><i class="fa-solid fa-location-dot"></i> RUA LUIZ CAMILO DE CAMARGO, 581, Centro, Hortolândia (13184-230) - a 0 m</p>
                        <p><i class="fa-regular fa-clock"></i> Segunda à sexta das 9 às 17:30 hs. - Sábado das 9 às 15 hs.</p>
                        <div class="agencia-footer">
                            <span>Chegará na agência quarta-feira <strong>R$ 5,99</strong></span>
                            <button class="btn-escolher">Escolher</button>
                        </div>
                    </div>
                    <div class="agencia-item">
                        <h4>PONTO EXTRA HORTOLÂNDIA</h4>
                        <p>Agência</p>
                        <p><i class="fa-solid fa-location-dot"></i> AV. DA EMACIPAÇÃO, 1200, Jardim Santa Rita de Cássia, Hortolândia (13186-505) - a 1,2 km</p>
                        <p><i class="fa-regular fa-clock"></i> Segunda à sábado das 8 às 18:30 hs. - Segunda à sábado das 14:30 às 18 hs. - Domingo das 8 às 12 hs.</p>
                        <div class="agencia-footer">
                            <span>Chegará na agência quarta-feira <strong>R$ 5,99</strong></span>
                            <button class="btn-escolher">Escolher</button>
                        </div>
                    </div>
                </div>
                <div class="mapa-container">
                    <div id="mapa"></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ... (Variáveis globais 'subtotalCompra' e 'map' - sem alteração) ...
        let subtotalCompra = 0.0;
        let map = null; 

        // ... (Funções 'mostrarModal' e 'fecharModal' - sem alteração) ...
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            if (modalId === 'modal-retirar-agencia' && !map) {
                const locais = [
                    { 
                        nome: 'LOJA 1',
                        endereco: 'RUA LUIZ CAMILO DE CAMARGO, 581, Centro, Hortolândia (13184-230)',
                        coords: { lat: -22.85848, lng: -47.22129 }
                    },
                    { 
                        nome: 'PONTO EXTRA HORTOLÂNDIA',
                        endereco: 'AV. DA EMACIPAÇÃO, 1200, Jardim Santa Rita de Cássia, Hortolândia (13186-505)',
                        coords: { lat: -22.86985, lng: -47.21461 }
                    }
                ];
                const centroDoMapa = [-22.864, -47.218]; 
                map = L.map('mapa').setView(centroDoMapa, 14); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                locais.forEach(local => {
                    L.marker([local.coords.lat, local.coords.lng]) 
                     .addTo(map)
                     .bindPopup(`<b>${local.nome}</b><br>${local.endereco}`);
                });
                
                setTimeout(() => {
                    map.invalidateSize();
                }, 100); 
            }
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ... (Função 'atualizarResumoEntrega' - sem alteração) ...
        function atualizarResumoEntrega() {
            const freteSelecionado = document.querySelector('input[name="forma-entrega"]:checked').value;
            const freteSpan = document.getElementById("resumo-frete-preco");
            let valorFrete = 0.0;
            let textoFrete = "GRÁTIS";
            
            if (freteSelecionado === 'agencia') {
                valorFrete = 5.99;
                textoFrete = "R$ 5,99";
                freteSpan.classList.remove("preco-gratis");
            } else {
                valorFrete = 0.0;
                textoFrete = "GRÁTIS";
                freteSpan.classList.add("preco-gratis");
            }
            
            const valorTotal = subtotalCompra + valorFrete;
            document.getElementById("resumo-produto-preco").innerText = "R$ " + subtotalCompra.toFixed(2).replace(".", ",");
            freteSpan.innerText = textoFrete;
            document.getElementById("resumo-total-preco").innerText = "R$ " + valorTotal.toFixed(2).replace(".", ",");

            localStorage.setItem("totalCompra", subtotalCompra.toFixed(2));
            localStorage.setItem("valorFrete", valorFrete.toFixed(2));
            localStorage.setItem("valorFinal", valorTotal.toFixed(2));
        }


        // ... (Lógica para selecionar as opções de entrega - sem alteração) ...
        document.querySelectorAll('input[name="forma-entrega"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.opcao-bloco').forEach(bloco => {
                    bloco.classList.remove('selecionado');
                });
                if (this.checked) {
                    this.closest('.opcao-bloco').classList.add('selecionado');
                }
                atualizarResumoEntrega();
            });
        });

        // --- Roda quando a página carrega ---
        document.addEventListener("DOMContentLoaded", () => {
            // ... (Lógica de carregar o subtotal - sem alteração) ...
            const totalSalvo = localStorage.getItem("totalCompra");
            if (totalSalvo) {
                subtotalCompra = parseFloat(totalSalvo);
            }
            atualizarResumoEntrega();

            
            // ==========================================================
            // === INÍCIO DA CORREÇÃO: Lógica "Escolher" Agência       ===
            // ==========================================================
            document.querySelectorAll('.btn-escolher').forEach(button => {
                button.addEventListener('click', (e) => {
                    
                    const itemAgencia = e.target.closest('.agencia-item');
                    const nomeAgencia = itemAgencia.querySelector('h4').innerText;
                    const horarioAgencia = itemAgencia.querySelector('i.fa-regular.fa-clock').parentElement.innerText;
                    
                    // --- Captura e Análise de Endereço da Agência ---
                    const pEndereco = itemAgencia.querySelector('i.fa-solid.fa-location-dot').parentElement.innerText;
                    // Ex: "RUA LUIZ CAMILO DE CAMARGO, 581, Centro, Hortolândia (13184-230) - a 0 m"
                    const regex = /^(.*?), (.*?), (.*?), (.*?) \((.*?)\)/;
                    const match = pEndereco.match(regex);
                    
                    let dadosAgencia = {};
                    if (match) {
                        dadosAgencia = {
                            tipo: 'agencia',
                            nome: nomeAgencia, // Nome (Ex: "LOJA 1" ou "PONTO EXTRA HORTOLÂNDIA")
                            documento: 'ISENTO', 
                            endereco: `${match[1]}, ${match[2]}`, // "RUA LUIZ CAMILO DE CAMARGO, 581"
                            bairro: match[3], // "Centro"
                            municipio: match[4], // "Hortolândia"
                            cep: match[5], // "13184-230"
                            uf: 'SP', 
                            fone: '(19) 3888-8888' // Telefone fictício da agência
                        };
                    } else {
                        // Fallback caso o regex falhe
                         dadosAgencia = { tipo: 'agencia', nome: nomeAgencia, endereco: pEndereco };
                    }
                    
                    // ***** ESTA LINHA É A CORREÇÃO *****
                    // Salva os dados da agência escolhida no localStorage
                    localStorage.setItem('dadosEntrega', JSON.stringify(dadosAgencia));
                    // ************************************

                    // Atualiza a UI da tela de entrega
                    const targetDetalhes = document.getElementById('detalhes-agencia-selecionada');
                    targetDetalhes.innerHTML = `
                        <p style="font-weight: 600; font-size: 15px;">${nomeAgencia}</p>
                        <p style="margin: 5px 0;">${horarioAgencia}</p>
                        <a href="#" class="link-acao" onclick="mostrarModal('modal-retirar-agencia')">Ver agência no mapa ou selecionar outra</a>
                    `;

                    // Seleciona o rádio 'retirar-agencia' e dispara o evento
                    const radioAgencia = document.getElementById('retirar-agencia');
                    radioAgencia.checked = true;
                    radioAgencia.dispatchEvent(new Event('change'));
                    
                    fecharModal('modal-retirar-agencia');
                });
            });
            // ==========================================================
            // === FIM DA CORREÇÃO                                    ===
            // ==========================================================

            
            // ... (Lógica de Validação do Modal de Endereço - sem alteração) ...
            const btnSalvarEndereco = document.getElementById('btn-salvar-endereco');
            const inputRua = document.getElementById('rua');
            const erroRua = document.getElementById('erro-rua');
            const inputNome = document.getElementById('nome');
            const erroNome = document.getElementById('erro-nome');

            btnSalvarEndereco.addEventListener('click', () => {
                let isValid = true; 
                erroRua.style.display = 'none';
                inputRua.classList.remove('input-erro');
                erroNome.style.display = 'none';
                inputNome.classList.remove('input-erro');
                if (inputRua.value.trim() === '') {
                    erroRua.style.display = 'block'; 
                    inputRua.classList.add('input-erro'); 
                    isValid = false;
                }
                if (inputNome.value.trim() === '') {
                    erroNome.style.display = 'block'; 
                    inputNome.classList.add('input-erro'); 
                    isValid = false;
                }
                if (isValid) {
                    fecharModal('modal-editar-endereco');
                }
            });

            // ... (Lógica do ViaCEP - sem alteração) ...
            const inputCep = document.getElementById('cep');
            function buscarCep() {
                const cep = inputCep.value.replace(/\D/g, ''); 
                erroRua.style.display = 'none';
                inputRua.classList.remove('input-erro');
                if (cep.length === 8) {
                    inputRua.value = "Buscando..."; 
                    fetch(`https://viacep.com.br/ws/${cep}/json/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.erro) {
                                inputRua.value = "";
                                inputRua.focus();
                            } else {
                                inputRua.value = data.logradouro;
                                document.getElementById('numero').focus();
                            }
                        })
                        .catch(error => {
                            console.error('Erro ao consultar a API ViaCEP:', error);
                            inputRua.value = "";
                        });
                } else if (cep.length > 0) {
                    inputRua.value = "";
                }
            }
            inputCep.addEventListener('blur', buscarCep);
            inputCep.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    buscarCep(); 
                }
            });

            // ... (Lógica da Busca de Localização (Mapa) - sem alteração) ...
            const inputBuscaLocal = document.getElementById('busca-local');
            const btnBuscaLocal = document.getElementById('btn-busca-local'); 
            function buscarLocalizacao() {
                const query = inputBuscaLocal.value;
                if (query.trim() === '') return;
                const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=br`;
                const originalPlaceholder = inputBuscaLocal.placeholder;
                inputBuscaLocal.placeholder = "Buscando...";
                inputBuscaLocal.disabled = true;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        inputBuscaLocal.placeholder = originalPlaceholder;
                        inputBuscaLocal.disabled = false;
                        if (data && data.length > 0) {
                            const result = data[0];
                            const lat = result.lat;
                            const lon = result.lon;
                            map.setView([lat, lon], 16); 
                        } else {
                            alert("Localização não encontrada.");
                        }
                    })
                    .catch(err => {
                        console.error("Erro ao buscar localização:", err);
                        alert("Não foi possível realizar a busca no momento.");
                        inputBuscaLocal.placeholder = originalPlaceholder;
                        inputBuscaLocal.disabled = false;
                    });
            }
            inputBuscaLocal.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    buscarLocalizacao(); 
                }
            });
            btnBuscaLocal.addEventListener('click', () => {
                buscarLocalizacao(); 
            });

            // ... (Lógica do botão Continuar - sem alteração) ...
            // (Esta lógica agora funciona, pois o localStorage estará correto)
            const btnContinuar = document.querySelector('.btn-continuar-entrega');
            if (btnContinuar) {
                btnContinuar.addEventListener('click', () => {
                    
                    const freteSelecionado = document.querySelector('input[name="forma-entrega"]:checked').value;
                    
                    if (freteSelecionado === 'endereco') {
                        const dadosHome = {
                            tipo: 'endereco',
                            nome: 'Fulano Silva', 
                            documento: '123.456.789-00', 
                            endereco: 'Exemplo Fictício, 123',
                            bairro: 'Centro',
                            cep: '13180-000',
                            municipio: 'Hortolândia',
                            uf: 'SP',
                            fone: '(19) 99999-9999'
                        };
                        localStorage.setItem('dadosEntrega', JSON.stringify(dadosHome));
                    
                    } else { // freteSelecionado === 'agencia'
                        
                        const dadosAtuaisJSON = localStorage.getItem('dadosEntrega');
                        let dadosAtuais = null;
                        if (dadosAtuaisJSON) {
                            try { dadosAtuais = JSON.parse(dadosAtuaisJSON); } catch(e) {}
                        }

                        if (!dadosAtuais || dadosAtuais.tipo !== 'agencia') {
                             const dadosDefaultAgencia = {
                                tipo: 'agencia',
                                nome: 'Agência - LOJA 1', 
                                documento: 'ISENTO', 
                                endereco: 'RUA LUIZ CAMILO DE CAMARGO, 581', 
                                bairro: 'Centro',
                                municipio: 'Hortolândia',
                                cep: '13184-230',
                                uf: 'SP',
                                fone: '(19) 3888-8888' 
                            };
                             localStorage.setItem('dadosEntrega', JSON.stringify(dadosDefaultAgencia));
                        }
                    }
                    
                    window.location.href = 'tela_pagamento.html';
                });
            }

            }); // <-- Fim do DOMContentLoaded

    </script>
</body>
</html>